input {
  beats {
    port => 5000
    host => "0.0.0.0"
  }
}

filter {
  json {
    source => "message"
    skip_on_invalid_json => true
     target => "parsed_json"  # 添加这行，将解析的 JSON 放入单独的命名空间
  }

    # 将 host、environment 和 service 作为独立字段处理，而不是作为 tags
  mutate {
    add_field => {
      "host" => "%{[parsed_json][host]}"
      "environment" => "%{[parsed_json][environment]}"
      "service" => "%{[parsed_json][service]}"
    }
    remove_field => ["tags"]  # 确保移除原始的 tags 字段
  }

  # 调试输出当前事件
  ruby {
    code => "
      require 'logger'
      logger = Logger.new(STDOUT)
      logger.info('Current event:')
      logger.info(event.to_hash.inspect)
    "
  }

  # 根据log_type设置目标索引
  if [log_type] == "user-activity" {
    mutate {
      add_field => { "[@metadata][index]" => "blog-user-activity-%{+YYYY.MM.dd}" }
      add_field => { "[@metadata][template_name]" => "user-activity-template" }
    }
  } else if [log_type] == "post-metrics" {
    mutate {
       add_field => { "[@metadata][index]" => "blog-post-metrics-%{+YYYY.MM.dd}" }
      add_field => { "[@metadata][template_name]" => "post-metrics-template" }
    }
  }
  else if [log_type] == "api-metrics" {
    mutate {
      add_field => { "[@metadata][index]" => "blog-api-metrics-%{+YYYY.MM.dd}" }
      add_field => { "[@metadata][template_name]" => "blog-template" }
    }
  } else if [log_type] == "error" {
    mutate {
      add_field => { "[@metadata][index]" => "blog-error-logs-%{+YYYY.MM.dd}" }
      add_field => { "[@metadata][template_name]" => "blog-template" }
    }
  } else if [log_type] == "system-metrics" {
    mutate {
      add_field => { "[@metadata][index]" => "blog-system-metrics-%{+YYYY.MM.dd}" }
      add_field => { "[@metadata][template_name]" => "blog-template" }
    }
  }

  # 如果没有匹配到任何类型，添加到默认索引
  if ![@metadata][index] {
    mutate {
      add_field => { "[@metadata][index]" => "blog-unknown-1" }
      add_field => { "[@metadata][template_name]" => "blog" }
      add_field => { "error_message" => "Unknown log_type: %{[log_type]}" }
    }
  }

  # 确保时间戳格式正确
  date {
    match => [ "@timestamp", "ISO8601" ]
    target => "@timestamp"
    timezone => "Asia/Shanghai"
  }

  # 移除不需要的字段
  mutate {
    remove_field => ["message", "tags", "beat", "input", "prospector", "agent"]
  }

  # 处理 host 字段（如果需要的话）
  mutate {
    rename => { "[host][name]" => "hostname" }
  }
}

output {
  if [@metadata][index] {
    if [@metadata][template_name] == "post-metrics-template" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        user => "${ELASTICSEARCH_USERNAME}"
        password => "${ELASTICSEARCH_PASSWORD}"
        index => "%{[@metadata][index]}"
        template => "/usr/share/logstash/templates/post-metrics-template.json"
        template_name => "post-metrics-template"
        template_overwrite => true
        data_stream => false
      }
    } else if [@metadata][template_name] == "user-activity-template" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        user => "${ELASTICSEARCH_USERNAME}"
        password => "${ELASTICSEARCH_PASSWORD}"
        index => "%{[@metadata][index]}"
        template => "/usr/share/logstash/templates/user-activity-template.json"
        template_name => "user-activity-template"
        template_overwrite => true
        data_stream => false
      }
    } else if [@metadata][template_name] == "blog-template" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        user => "${ELASTICSEARCH_USERNAME}"
        password => "${ELASTICSEARCH_PASSWORD}"
        index => "%{[@metadata][index]}"
        template => "/usr/share/logstash/templates/blog-template.json"
        template_name => "blog-template"
        template_overwrite => true
        data_stream => false
      }
    }
  }
}